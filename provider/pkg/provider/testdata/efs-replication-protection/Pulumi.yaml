name: efs-replication-protection
runtime: yaml
description: Test EFS FileSystem replication where destination transitions to REPLICATING state

resources:
  # AWS Native providers for EFS file systems
  eastNativeProvider:
    type: pulumi:providers:aws-native
    properties:
      region: us-east-1

  westNativeProvider:
    type: pulumi:providers:aws-native
    properties:
      region: us-west-2

  # Classic AWS provider for ReplicationConfiguration (handles cleanup order correctly)
  eastAwsProvider:
    type: pulumi:providers:aws
    properties:
      region: us-east-1

  # Destination filesystem - created first, will transition to REPLICATING when replication starts
  efsDestination:
    type: aws-native:efs:FileSystem
    properties:
      performanceMode: generalPurpose
      throughputMode: elastic
      encrypted: true
      fileSystemProtection:
        replicationOverwriteProtection: DISABLED
    options:
      provider: ${westNativeProvider}

  # Source filesystem - NO inline replicationConfiguration (use sidecar resource instead)
  efsSource:
    type: aws-native:efs:FileSystem
    properties:
      performanceMode: generalPurpose
      throughputMode: elastic
      encrypted: true
      fileSystemProtection:
        replicationOverwriteProtection: ENABLED
    options:
      provider: ${eastNativeProvider}
      dependsOn:
        - ${efsDestination}

  # Sidecar ReplicationConfiguration resource using classic AWS provider.
  # This allows Pulumi to delete replication BEFORE the file systems during destroy.
  efsReplication:
    type: aws:efs:ReplicationConfiguration
    properties:
      sourceFileSystemId: ${efsSource.id}
      destination:
        fileSystemId: ${efsDestination.id}
        region: us-west-2
    options:
      provider: ${eastAwsProvider}

outputs:
  # Basic identifiers
  sourceId: ${efsSource.id}
  sourceArn: ${efsSource.arn}
  destinationId: ${efsDestination.id}
  destinationArn: ${efsDestination.arn}

  # FileSystemProtection - destination changes from DISABLED to REPLICATING
  sourceProtection: ${efsSource.fileSystemProtection.replicationOverwriteProtection}
  destinationProtection: ${efsDestination.fileSystemProtection.replicationOverwriteProtection}

  # Full fileSystemProtection objects for debugging
  sourceFileSystemProtection: ${efsSource.fileSystemProtection}
  destinationFileSystemProtection: ${efsDestination.fileSystemProtection}
