name: efs-replication-protection
runtime: yaml
description: Test EFS FileSystem replication where destination transitions to REPLICATING state

resources:
  eastNativeProvider:
    type: pulumi:providers:aws-native
    properties:
      region: us-east-1

  westNativeProvider:
    type: pulumi:providers:aws-native
    properties:
      region: us-west-2

  eastClassicProvider:
    type: pulumi:providers:aws
    properties:
      region: us-east-1
      skipCredentialsValidation: true
      skipMetadataApiCheck: true

  efsSource:
    type: aws-native:efs:FileSystem
    properties:
      performanceMode: generalPurpose
      throughputMode: elastic
      encrypted: true
      fileSystemProtection:
        replicationOverwriteProtection: ENABLED
    options:
      provider: ${eastNativeProvider}

  efsDestination:
    type: aws-native:efs:FileSystem
    properties:
      performanceMode: generalPurpose
      throughputMode: elastic
      encrypted: true
      fileSystemProtection:
        replicationOverwriteProtection: DISABLED
    options:
      provider: ${westNativeProvider}

  efsReplication:
    type: aws:efs:ReplicationConfiguration
    properties:
      sourceFileSystemId: ${efsSource.id}
      destination:
        region: us-west-2
        fileSystemId: ${efsDestination.id}
    options:
      provider: ${eastClassicProvider}
      dependsOn:
        - ${efsSource}
        - ${efsDestination}

outputs:
  sourceId: ${efsSource.id}
  sourceProtection: ${efsSource.fileSystemProtection.replicationOverwriteProtection}
  destinationId: ${efsDestination.id}
  destinationProtection: ${efsDestination.fileSystemProtection.replicationOverwriteProtection}
