name: efs-replication-protection
runtime: yaml
description: Test EFS FileSystem replication where destination transitions to REPLICATING state

resources:
  eastNativeProvider:
    type: pulumi:providers:aws-native
    properties:
      region: us-east-1

  westNativeProvider:
    type: pulumi:providers:aws-native
    properties:
      region: us-west-2

  # Destination filesystem - created first, will transition to REPLICATING when replication starts
  efsDestination:
    type: aws-native:efs:FileSystem
    properties:
      performanceMode: generalPurpose
      throughputMode: elastic
      encrypted: true
      fileSystemProtection:
        replicationOverwriteProtection: DISABLED
    options:
      provider: ${westNativeProvider}

  # Source filesystem with inline replicationConfiguration (not sidecar resource)
  efsSource:
    type: aws-native:efs:FileSystem
    properties:
      performanceMode: generalPurpose
      throughputMode: elastic
      encrypted: true
      fileSystemProtection:
        replicationOverwriteProtection: ENABLED
      # Use inline replicationConfiguration instead of sidecar resource
      replicationConfiguration:
        destinations:
          - region: us-west-2
            fileSystemId: ${efsDestination.id}
    options:
      provider: ${eastNativeProvider}
      dependsOn:
        - ${efsDestination}

outputs:
  # Basic identifiers
  sourceId: ${efsSource.id}
  sourceArn: ${efsSource.arn}
  destinationId: ${efsDestination.id}
  destinationArn: ${efsDestination.arn}

  # FileSystemProtection - destination changes from DISABLED to REPLICATING
  sourceProtection: ${efsSource.fileSystemProtection.replicationOverwriteProtection}
  destinationProtection: ${efsDestination.fileSystemProtection.replicationOverwriteProtection}

  # Full fileSystemProtection objects for debugging
  sourceFileSystemProtection: ${efsSource.fileSystemProtection}
  destinationFileSystemProtection: ${efsDestination.fileSystemProtection}
